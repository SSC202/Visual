# PCL-C++ 7_点云特征描述

3D 点云特征描述与提取是点云信息处理中最基础也是最关键的一部分。点云的识别、分割、重采样、配准曲面重建等处理，大部分算法都依赖特征描述符提取的结果。从尺度上来分，一般分为局部特征的描述和全局特征的描述，例如局部的法线等几何形状特征的描述，全局的拓扑特征的描述，都属于 3D 点云特征描述与提取的范畴。

> **常用的点云特征描述：**
>
> 1. 法线和曲率计算
> 2. 特征值分析
> 3. PFH 点特征直方图描述子
> 4. FPFH 快速点特征直方图描述子 FPFH
> 5. 3D形状内容描述子
> 6. 纹理特征
> 7. 深度图
> 8. VFH  视点特征直方图
> 9. NARF 关键点特征
> 10. RoPs 特征
> 11. GASD 全局一致的空间分布描述子特征 
> 12. 旋转图像

特征描述子能够表征采样表面的几何性质，它有助于解决不适定的对比问题，理想情况下相同或相似表面上的点的特征值将非常相似（相对特定度量准则），而不同表面上的点的特征描述子将有明显差异。下面几个条件，通过能否获得相同的局部表面特征值，可以判定点特征表示方式的优劣。

> 1. **平移旋转不变性**（刚体变换）：即三维旋转和三维平移变化不会影响特征向量估计。
> 2. **抗密度干扰性**（改变采样密度）：原则上，一个局部表面小块的采样密度无论是大还是小，都应该有相同的特征向量值。
> 3. **对噪声具有稳定性**（噪声）：数据中有轻微噪声的情况下，点特征表示在它的特征向量中必须保持相同或者极其相似的值。

## 1. 法向量

- 法向量估计

    基于局部表面拟合的方法进行法向量估计，点云的采样表面处处光滑的情况下，任何点的局部邻域都可以用平面进行很好的拟合。

    为此，对于点云中的每个扫描点 $p$，搜索到与其最近邻的 $K$ 个相邻点，然后计算这些点最小二乘意义上的局部平面 $P$，此平面可以表示为：
    $$
    P(\vec n,d) = argmin \sum^k_{i=1}(\vec n \cdot p_i - d)^2
    $$
    式中，$\vec n$为平面 $P$ 的法向量，$d$ 为 $P$ 到坐标原点的距离。

    可以认为由 $K$ 个最近邻点拟合出的平面的法向量即当前扫描点的法向量。平面 $P$ 的法向量可以由主成分分析得到。

    $P$ 经过其 $K$ 邻域点的质心 $p_0$ ，且法向量 $\vec{n}$ 满足 $||\vec{n}||=1$ 。
    $$
    M = \frac{1}{K}\sum^K_1(p_i-p_0)(p_i-p_0)^T
    $$
    对协方差矩阵 $M$ 进行特征值分解，求得 $M$ 的各特征值，$M$ 的最小特征值所对应的特征向量即 $P$ 的法向量。

- 法向量定向

  法向量具有二义性，即只是得到了法向量所在的直线，而没有确定以直线的哪个方向为法向量的最终方向。

  假设点云足够稠密且采样平面处处光滑，那么相邻两点的法向量会接近于平行。令 $\vec{n_i},\vec{n_j}$ 为相邻两点 $x_i,x_j$ 的法向量，如果法向量的方向是一致的，那么 $\vec{n_i}\cdot\vec{n_j}\approx1$ ，若此内积为负，则说明其中某个点的法向量需要被翻转。因此，首先为点云中某个点设定一个法向量朝向，然后遍历其他所有点，若当前点法向量设定为$\vec{n_i}$，$\vec{n_j}$为下一个要遍历的点，如果$\vec{n_i}\cdot\vec{n_j}<0$，则将$ \vec{n_j}$翻转，否则保持不变。

```c++
	pcl::NormalEstimationOMP<pcl::PointXYZ, pcl::Normal> n;										//OMP加速
	pcl::PointCloud<pcl::Normal>::Ptr normals(new pcl::PointCloud<pcl::Normal>);
	pcl::search::KdTree<pcl::PointXYZ>::Ptr tree(new pcl::search::KdTree<pcl::PointXYZ>()); 	//建立kdtree来进行近邻点集搜索
	n.setNumberOfThreads(10);																	//设置openMP的线程数
	//n.setViewPoint(0,0,0);																	//设置视点，默认为（0，0，0）
	n.setInputCloud(cloud);
	n.setSearchMethod(tree);
	n.setKSearch(10);																			//点云法向计算时，需要所搜的近邻点大小
	//n.setRadiusSearch(0.03);																	//半径搜素
	n.compute(*normals);																		//开始进行法向量计算
```

> `n.compute(*normal)`里计算出来的结果是：法向量的`x`,`y`,`z`坐标和表面曲率`curvature`。
